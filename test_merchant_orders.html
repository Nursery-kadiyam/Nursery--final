<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Merchant Orders</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Merchant Orders</h1>
    <div id="status"></div>
    <div id="results"></div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://nlrdxgcckfgsgivljmkf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5scmR4Z2Nja2Znc2dpdmxqbWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzQ4MDAsImV4cCI6MjA1MDU1MDgwMH0.8QZqZqZqZqZqZqZqZqZqZqZqZqZqZqZqZqZqZqZqZq';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function testMerchantOrders() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = 'Testing merchant orders...';
            
            try {
                // Test 1: Get all merchants
                console.log('Fetching merchants...');
                const { data: merchants, error: merchantsError } = await supabase
                    .from('merchants')
                    .select('id, merchant_code, nursery_name, user_id')
                    .order('created_at', { ascending: false });
                
                if (merchantsError) {
                    throw new Error(`Error fetching merchants: ${merchantsError.message}`);
                }
                
                console.log('Merchants found:', merchants);
                resultsDiv.innerHTML += '<h3>Merchants:</h3><pre>' + JSON.stringify(merchants, null, 2) + '</pre>';
                
                // Test 2: Get all orders
                console.log('Fetching all orders...');
                const { data: allOrders, error: allOrdersError } = await supabase
                    .from('orders')
                    .select('id, order_code, merchant_code, merchant_id, parent_order_id, created_at, total_amount')
                    .order('created_at', { ascending: false });
                
                if (allOrdersError) {
                    throw new Error(`Error fetching orders: ${allOrdersError.message}`);
                }
                
                console.log('All orders:', allOrders);
                resultsDiv.innerHTML += '<h3>All Orders:</h3><pre>' + JSON.stringify(allOrders, null, 2) + '</pre>';
                
                // Test 3: Get child orders (orders with parent_order_id)
                console.log('Fetching child orders...');
                const { data: childOrders, error: childOrdersError } = await supabase
                    .from('orders')
                    .select('id, order_code, merchant_code, merchant_id, parent_order_id, created_at, total_amount')
                    .not('parent_order_id', 'is', null)
                    .order('created_at', { ascending: false });
                
                if (childOrdersError) {
                    throw new Error(`Error fetching child orders: ${childOrdersError.message}`);
                }
                
                console.log('Child orders:', childOrders);
                resultsDiv.innerHTML += '<h3>Child Orders (Merchant Orders):</h3><pre>' + JSON.stringify(childOrders, null, 2) + '</pre>';
                
                // Test 4: Test merchant-specific queries
                for (const merchant of merchants) {
                    console.log(`Testing orders for merchant ${merchant.merchant_code}...`);
                    
                    // Query by merchant_id
                    const { data: ordersByMerchantId, error: error1 } = await supabase
                        .from('orders')
                        .select('id, order_code, merchant_code, merchant_id, parent_order_id, created_at, total_amount')
                        .eq('merchant_id', merchant.id)
                        .not('parent_order_id', 'is', null);
                    
                    // Query by merchant_code
                    const { data: ordersByMerchantCode, error: error2 } = await supabase
                        .from('orders')
                        .select('id, order_code, merchant_code, merchant_id, parent_order_id, created_at, total_amount')
                        .eq('merchant_code', merchant.merchant_code)
                        .not('parent_order_id', 'is', null);
                    
                    console.log(`Orders for ${merchant.merchant_code} by merchant_id:`, ordersByMerchantId);
                    console.log(`Orders for ${merchant.merchant_code} by merchant_code:`, ordersByMerchantCode);
                    
                    resultsDiv.innerHTML += `<h3>Orders for ${merchant.nursery_name} (${merchant.merchant_code}):</h3>`;
                    resultsDiv.innerHTML += `<p><strong>By merchant_id:</strong> ${ordersByMerchantId?.length || 0} orders</p>`;
                    resultsDiv.innerHTML += `<p><strong>By merchant_code:</strong> ${ordersByMerchantCode?.length || 0} orders</p>`;
                    
                    if (ordersByMerchantId && ordersByMerchantId.length > 0) {
                        resultsDiv.innerHTML += '<pre>' + JSON.stringify(ordersByMerchantId, null, 2) + '</pre>';
                    }
                }
                
                // Test 5: Check for orders with missing merchant_id
                const ordersWithMissingMerchantId = allOrders.filter(order => 
                    order.parent_order_id !== null && 
                    order.merchant_id === null && 
                    order.merchant_code !== 'admin'
                );
                
                if (ordersWithMissingMerchantId.length > 0) {
                    resultsDiv.innerHTML += '<h3 style="color: red;">⚠️ Orders with Missing merchant_id:</h3>';
                    resultsDiv.innerHTML += '<pre>' + JSON.stringify(ordersWithMissingMerchantId, null, 2) + '</pre>';
                } else {
                    resultsDiv.innerHTML += '<h3 style="color: green;">✅ All child orders have merchant_id</h3>';
                }
                
                statusDiv.innerHTML = 'Test completed!';
                
            } catch (error) {
                console.error('Test failed:', error);
                statusDiv.innerHTML = 'Test failed!';
                resultsDiv.innerHTML += '<h3>Test Error:</h3><pre>' + error.message + '</pre>';
            }
        }

        // Run the test when page loads
        window.addEventListener('load', testMerchantOrders);
    </script>
</body>
</html>