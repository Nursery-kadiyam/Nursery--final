<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #166534;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            border: 1px solid #2563eb;
            color: #1e40af;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .order-details {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .item-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #1d4ed8;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <h1>üîß Test Final Fix</h1>
    <p>This page tests the complete RLS and order items fix.</p>
    
    <div class="container">
        <h2>üìã Step 1: Apply Database Fix</h2>
        <div class="warning">
            <h3>‚ö†Ô∏è Important</h3>
            <p>Run the SQL script <code>fix_complete_rls_and_order_items.sql</code> in your Supabase SQL editor.</p>
            <p>This will:</p>
            <ul>
                <li>Enable RLS on merchants, products, quotations, user_profiles tables</li>
                <li>Create proper RLS policies for all tables</li>
                <li>Create merchant and user order functions</li>
                <li>Populate missing order_items for ORD-2025-0005</li>
            </ul>
        </div>
        <button class="button" onclick="runTest()">Run Test</button>
    </div>

    <div class="container">
        <h2>üìä Test Results</h2>
        <div id="test-results" class="loading">Click "Run Test" to check the fix...</div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Initialize Supabase client
        const supabaseUrl = 'https://your-project.supabase.co'; // Replace with your URL
        const supabaseKey = 'your-anon-key'; // Replace with your anon key
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        async function runTest() {
            try {
                document.getElementById('test-results').innerHTML = '<div class="loading">Running tests...</div>';
                
                let resultsHtml = '';
                
                // Test 1: Check merchant function
                try {
                    const { data: merchantOrders, error: merchantError } = await supabase
                        .rpc('get_merchant_orders_with_items', {
                            p_merchant_code: 'MC-2025-TXYR'
                        });
                    
                    if (merchantError) {
                        resultsHtml += `
                            <div class="error">
                                <h3>‚ùå Merchant Function Failed</h3>
                                <p><strong>Error:</strong> ${merchantError.message}</p>
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="success">
                                <h3>‚úÖ Merchant Function Working</h3>
                                <p>Found ${merchantOrders.length} orders for merchant MC-2025-TXYR</p>
                            </div>
                        `;
                        
                        // Show order details
                        if (merchantOrders.length > 0) {
                            const order = merchantOrders[0];
                            resultsHtml += `
                                <div class="order-details">
                                    <h4>Order ${order.order_code} Details:</h4>
                                    <p><strong>Customer:</strong> ${order.customer_name}</p>
                                    <p><strong>Total:</strong> ‚Çπ${order.total_amount}</p>
                                    <p><strong>Items:</strong> ${order.order_items.length}</p>
                                    
                                    ${order.order_items.length > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <strong>Order Items:</strong>
                                            ${order.order_items.map(item => `
                                                <div class="item-card">
                                                    <div>
                                                        <strong>${item.product_name || 'Unknown Product'}</strong><br>
                                                        <small>ID: ${item.id}</small>
                                                    </div>
                                                    <div>
                                                        <strong>Quantity:</strong> ${item.quantity}<br>
                                                        <strong>Unit Price:</strong> ‚Çπ${item.unit_price}<br>
                                                        <strong>Subtotal:</strong> ‚Çπ${item.subtotal}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<div style="color: #ef4444; margin-top: 10px;">‚ö†Ô∏è No items found</div>'}
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    resultsHtml += `
                        <div class="error">
                            <h3>‚ùå Merchant Function Test Failed</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                }
                
                // Test 2: Direct order query
                try {
                    const { data: order, error: orderError } = await supabase
                        .from('orders')
                        .select(`
                            id, order_code, merchant_code, total_amount, status, created_at,
                            cart_items, delivery_address,
                            order_items(id, quantity, unit_price, subtotal, product_id, products(name, image_url))
                        `)
                        .eq('order_code', 'ORD-2025-0005')
                        .single();
                    
                    if (orderError) {
                        resultsHtml += `
                            <div class="error">
                                <h3>‚ùå Order Query Failed</h3>
                                <p><strong>Error:</strong> ${orderError.message}</p>
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="success">
                                <h3>‚úÖ Order Query Working</h3>
                                <p>Successfully retrieved order ORD-2025-0005</p>
                            </div>
                        `;
                        
                        if (order.order_items && order.order_items.length > 0) {
                            resultsHtml += `
                                <div class="success">
                                    <h3>‚úÖ Order Items Found</h3>
                                    <p>Order has ${order.order_items.length} items with proper product names!</p>
                                </div>
                            `;
                        } else {
                            resultsHtml += `
                                <div class="error">
                                    <h3>‚ùå No Order Items</h3>
                                    <p>Order still has no order_items records.</p>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    resultsHtml += `
                        <div class="error">
                            <h3>‚ùå Order Query Test Failed</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                }
                
                // Test 3: Check RLS policies
                try {
                    const { data: merchants, error: merchantsError } = await supabase
                        .from('merchants')
                        .select('merchant_code')
                        .limit(1);
                    
                    if (merchantsError) {
                        resultsHtml += `
                            <div class="warning">
                                <h3>‚ö†Ô∏è Merchants Table Access Issue</h3>
                                <p><strong>Error:</strong> ${merchantsError.message}</p>
                                <p>This might indicate RLS policy issues.</p>
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="success">
                                <h3>‚úÖ Merchants Table Access Working</h3>
                                <p>RLS policies are properly configured.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultsHtml += `
                        <div class="error">
                            <h3>‚ùå RLS Policy Test Failed</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                }
                
                // Final summary
                const hasErrors = resultsHtml.includes('‚ùå');
                resultsHtml += `
                    <div class="${hasErrors ? 'warning' : 'success'}">
                        <h3>${hasErrors ? '‚ö†Ô∏è Some Issues Found' : 'üéâ All Tests Passed!'}</h3>
                        <p>${hasErrors ? 
                            'Please review the errors above and ensure the SQL script was run completely.' : 
                            'The fix is working correctly! The merchant dashboard should now show order items properly.'}</p>
                    </div>
                `;
                
                document.getElementById('test-results').innerHTML = resultsHtml;
                
            } catch (error) {
                document.getElementById('test-results').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Initialize
        console.log('Final Fix Test initialized');
        console.log('This test verifies:');
        console.log('1. RLS policies are properly configured');
        console.log('2. Merchant function works correctly');
        console.log('3. Order items are populated and accessible');
        console.log('4. Order ORD-2025-0005 displays items correctly');
    </script>
</body>
</html>